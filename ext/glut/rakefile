#-*-ruby-*-
#--
# Copyright 2006 by Peter McLain
# All rights reserved.
# See MIT-LICENSE for permissions.
#++

require 'rake/clean'
require 'rbconfig'

case RUBY_PLATFORM
when /darwin/
    extconf_args = "--with-ldflags='-framework GLUT'"
    # Don't understand why swig doesn't define this...
    swig_args = "-DSWIGMAC"
else
    extconf_args = ""
    swig_args = "-I/usr/include"
end

# The module we are trying to build
ext_name = 'glut'
# The library name, e.g., "gl.bundle" or "gl.so"
ext = "#{ext_name}.#{Config::CONFIG['DLEXT']}"

CLEAN.include('*_wrap.*')
CLOBBER.include('Makefile', "*.#{Config::CONFIG['DLEXT']}")

# This rule tells rake how to use swig to make foo_wrap.c from foo.i
rule '.c' => [ proc { |tn| tn.sub(/_wrap\.[^.]+$/, '.i') } ] do |t|
    sh "swig #{swig_args} -ruby #{t.source}"
end

desc "Build the GLUT ruby extension"
task :default => [ ext ]

file 'glut_wrap.c' => %w( glut.i glut_init.i glut_callbacks.i )

# we create the makefile using mkmf, but mkmf doesn't want to work unless
# glut_wrap.c exists, so...
file 'Makefile' => [ "#{ext_name}_wrap.c", 'extconf.rb' ] do |t|
    ruby "extconf.rb #{extconf_args}"
end

file ext => [ 'Makefile', "#{ext_name}_wrap.c" ] do |t|
    sh 'make'
end
