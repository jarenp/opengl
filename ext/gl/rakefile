#-*-ruby-*-
#--
# Copyright (C) 2006 Peter McLain <peter.mclain@gmail.com>
#
# This program is distributed under the terms of the MIT license.
# See the included MIT-LICENSE file for the terms of this license.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
# CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
# TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#++

require 'rake/clean'
require 'rbconfig'

case RUBY_PLATFORM
when /darwin/
    extconf_args = "--with-ldflags='-framework OpenGL'"
    # Don't understand why swig doesn't define this...
    swig_args = "-DSWIGMAC"
else
    extconf_args = "--with-ldflags='-lGL'"
    swig_args = "-I/usr/include"
end

# Add swig parameters passed in via "rake VAR=VALUE"
# The currently known parameters are:
#
#  RBOGL_UNTYPED:  If set, then include the gl_untyped.i file
swig_args << " -DRBOGL_UNTYPED" if ENV['RBOGL_UNTYPED']

# The module we are trying to build
ext_name = 'gl'
# The library name, e.g., "gl.bundle" or "gl.so"
ext = "#{ext_name}.#{Config::CONFIG['DLEXT']}"

CLEAN.include('*_wrap.*', 'rbogl.o')
CLOBBER.include('Makefile', "*.#{Config::CONFIG['DLEXT']}")

# This rule tells rake how to use swig to make foo_wrap.c from foo.i
rule '.c' => [ proc { |tn| tn.sub(/_wrap\.[^.]+$/, '.i') } ] do |t|
    sh "swig #{swig_args} -ruby #{t.source}"
end

desc "Build the GL ruby extension"
task :default => [ ext ]

file 'gl_wrap.c' => %w( gl.i gl_untyped.i )

# we create the makefile using mkmf, but mkmf doesn't want to work unless
# glut_wrap.c exists, so...
file 'Makefile' => [ "#{ext_name}_wrap.c", 'extconf.rb' ] do |t|
    ruby "extconf.rb #{extconf_args}"
end

file ext => [ 'Makefile', "#{ext_name}_wrap.c" ] do |t|
    sh 'make'
end
